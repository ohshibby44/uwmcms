<?php

/**
 * @file
 * Module for reading an API and providing API data to themes.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\uwmcs_reader\Controller\UwmFetcher;

/**
 * Implements hook_node_view().
 *
 * @TODO: Change this to node_load().
 */
function uwmcs_reader_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {

  $args = explode('/', trim(
    \Drupal::request()->getRequestUri(), '/'));

  if ($entity->getType() === "uwm_clinic") {

    // Fetch Information Manager (IM) data from API endpoint.
    $fetcher = new UwmFetcher();
    $data = $fetcher->getUrl($entity->field_information_manager_url->value);

    // If missing, try to find clinic data on API.
    if (empty((array) $data)) {
      $data = $fetcher->getClinic(['clinicUrl' => '/locations/' . $args[1]]);
    }

    // If we have a location, fetch additional details and driving directions.
    if (!empty($data->location->url)) {
      $location = $fetcher->getUrl($data->location->url);
      if (!empty($location->id)) {
        $data->location = $location;
      }
    }

    // Attach all bio details.
    // @TODO: Change this attach bio-node.
    if (!empty($data->careNetworks)) {

      foreach ($data->careNetworks as &$network) {

        foreach ($network->bioInformations as &$bio) {

          if (!empty($bio->url)) {
            $detail = $fetcher->getUrl($bio->url);
            if (!empty($bio->id)) {
              $bio = $detail;
            }

          }

        }

      }

    }

    $entity->uwmcs_reader_api_values = $data;

  }

  if ($entity->getType() === "uwm_provider") {

    // Fetch Information Manager (IM) data from API endpoint.
    $fetcher = new UwmFetcher();
    $data = $fetcher->getUrl($entity->field_information_manager_url->value);

    // If missing, try to find clinic data on API.
    if (empty((array) $data)) {
      $data = $fetcher->getProvider(['friendlyUrl' => $args[1]]);
    }

    $entity->uwmcs_reader_api_values = $data;

  }

}
